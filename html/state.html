<html lang="zh">
<header>
    <meta charset="UTF-8"/>
    <title>Socks5BalancerAsio</title>
    <style type="text/css">
        th {
            border: black 0 dashed;
            border-left-width: 1px;
            border-bottom: lightslategrey 1px solid;
        }

        td {
            border: lightslategrey 1px solid;
            border-right-width: 0;
            border-top-width: 0;
        }

        tr:hover {
            background-color: lightblue;
        }

        tfoot > tr:hover {
            background-color: inherit;
        }

        .string-pad {
            margin: 0 0.5em 0 0.5em;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.26.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.26.0/locale/zh-cn.js"></script>
</header>
<body>
<div id="body">
    now running connect: <span class="string-pad">{{ allConnectCount }}</span>
    <br/>
    now rule: <span class="string-pad">{{ rule }}</span>
    <br/>
    <form action="/op" method="get" target="_self">
        <select name="newRule" v-model="newRule">
            <template v-for="u in UpstreamSelectRuleList">
                <option v-if="u===rule" v-bind:value="u" selected>{{ u }}</option>
                <option v-else v-bind:value="u">{{ u }}</option>
            </template>
        </select>
        <input type="button" value="Change It"
               v-on:click="sendCommand('/op?newRule=' + newRule)"
        />
    </form>
    <label>
        backend:
        <input class="string-pad" name="backend" v-model="backend"/>
    </label>
    <button v-on:click="flush">Flush</button>
    <br/>
    <template v-if="!upstreamPool.find(function(u) {
      return u.isWork==='true';
    })">
        <h3 style="color: red">Warning: we don't have Usable Server !!! </h3>
        <br/>
    </template>
    ---------------------------------------------------------------------------------------------
    <br/>
    <table style="border: black 3px dashed;">
        <thead>
        <tr>
            <th style="border-left-width: 0;">No.</th>
            <th>Host:Port</th>
            <th>name</th>
            <th>online</th>
            <th>connectable</th>
            <th>running</th>
            <th>lastTCPCheckTime</th>
            <th>lastConnectCheckTime</th>
            <th>ManualDisable</th>
            <th>Usable</th>
            <th>Close Connect</th>
            <th>Select</th>
            <th>data</th>
            <th>speedMax</th>
            <th>speed</th>
            <!--        <th></th>-->
        </tr>
        </thead>
        <tbody>

        <tr v-for="u in upstreamPool">
            <td style="border-left-width: 0;">{{_.parseInt(u.index) + 1}}.</td>
            <td>{{u.host}}:{{u.port}}</td>
            <td>{{u.name}}</td>
            <td>
                <span style="color: gray" v-if="u.lastOnlineTime==='<empty>'">Unknown</span>
                <span style="color: green" v-else-if="u.isOffline==='false'">True</span>
                <span style="color: red" v-else>False</span>
            </td>
            <td>
                <span style="color: gray" v-if="u.lastConnectTime==='<empty>'">Unknown</span>
                <span style="color: green" v-else-if="u.lastConnectFailed==='false'">True</span>
                <span style="color: red" v-else>False</span>
            </td>
            <td>{{u.connectCount}}</td>
            <td>{{u.lastOnlineTime}}</td>
            <td>{{u.lastConnectTime}}</td>
            <td>
                <template v-if="u.isManualDisable==='true'">
                    <span style="color: red">Disabled</span>
                    <a href="javascript:void(0)"
                       v-on:click="sendCommand('/op?enable=' + _.parseInt(u.index))"
                    >
                        Enable It
                    </a>
                </template>
                <template v-else>
                    <span style="color: green">Enabled</span>
                    <a href="javascript:void(0)"
                       v-on:click="sendCommand('/op?disable=' + _.parseInt(u.index))"
                    >
                        Disable It
                    </a>
                </template>
            </td>
            <td>
                <span style="color: green" v-if="u.isWork==='true'">True</span>
                <span style="color: red" v-else-if="u.isWork==='false'">False</span>
            </td>
            <td>
                <a href="javascript:void(0)"
                   v-on:click="sendCommand('/op?endConnectOnServer=' + _.parseInt(u.index))"
                >
                    Close Connect
                </a>
            </td>
            <td>
                <a href="javascript:void(0)"
                   v-on:click="sendCommand('/op?forceNowUseServer=' + _.parseInt(u.index))"
                >
                    Use This Now
                </a>
            </td>
            <td>{{formatData(u)}}</td>
            <td>{{formatSpeedMax(u)}}</td>
            <td>{{formatSpeed(u)}}</td>
            <!--            <td></td>-->
        </tr>

        </tbody>
        <tfoot>
        <tr>
            <td colspan="14">
                <a href="javascript:void(0)"
                   v-on:click="sendCommand('/op?cleanAllCheckState=1')"
                   style="margin-right: 1em;"
                >
                    Clean Check State
                </a>
                <a href="javascript:void(0)"
                   v-on:click="sendCommand('/op?endAllConnect=1')"
                   style="margin-right: 1em;"
                >
                    Force Close All Connect
                </a>
                <a href="javascript:void(0)"
                   v-on:click="sendCommand('/op?forceCheckAllServer=1')"
                   style="margin-right: 1em;"
                >
                    Force Check All Now
                </a>
            </td>
        </tr>
        </tfoot>
    </table>
    ---------------------------------------------------------------------------------------------
    <br/>
    lastConnectServer:
    <span class="string-pad">
        {{ (lastConnectServer?(lastConnectServer.host+':'+lastConnectServer.port):'Undefined') }}
    </span>
    <br/>
    lastUseUpstreamIndex: <span class="string-pad">{{ _.parseInt(lastUseUpstreamIndex) + 1 }}</span>
    <br/>
    <br/>
    totalUp: <span class="string-pad">{{ dataCount2String(totalUp) }}</span>
    <br/>
    totalDown: <span class="string-pad">{{ dataCount2String(totalDown) }}</span>
    <br/>
    totalUpSpeed: <span class="string-pad">{{ speed2String(totalUpSpeed) }}</span>
    <br/>
    totalDownSpeed: <span class="string-pad">{{ speed2String(totalDownSpeed) }}</span>
    <br/>
    totalUpSpeedMax: <span class="string-pad">{{ speed2String(totalUpSpeedMax) }}</span>
    <br/>
    totalDownSpeedMax: <span class="string-pad">{{ speed2String(totalDownSpeedMax) }}</span>
    <br/>
    <br/>
    now time: <span class="string-pad">{{ nowTime }}</span>
    <br/>
    startTime: <span class="string-pad">{{ startTime }}</span>
    <br/>
    runTime: <span class="string-pad">{{ runTime }} ms</span>
    <br/>
    runTime: <span class="string-pad">{{ runTimeString }}</span>
    <br/>
    runTime: <span class="string-pad">{{ runTimeString2 }}</span>
    <br/>
    listen On: <span class="string-pad">{{ listenOn }}</span>
    <br/>
    ---------------------------------------------------------------------------------------------
    <br/>
    <h5>Fast Issue Resolve</h5>
    <ul>
        <li>Web page Open very Sloooow :&emsp;<a href="javascript:void(0)"
                                                 v-on:click="sendCommand('/op?endAllConnect=1')">
            Force Close All Connect
        </a></li>
        <li>Seems like Server State not update :&emsp;<a href="javascript:void(0)"
                                                         v-on:click="sendCommand('/op?forceCheckAllServer=1')">
            Force Check All Now
        </a></li>
        <li>I Want To Disable All Server :&emsp;<a href="javascript:void(0)"
                                                   v-on:click="sendCommand('/op?disableAllServer=1')">
            Disable All Server
        </a></li>
        <li>I Want To Enable All Server :&emsp;<a href="javascript:void(0)"
                                                  v-on:click="sendCommand('/op?enableAllServer=1')">
            Enable All Server
        </a></li>
    </ul>
    <br/>
    ---------------------------------------------------------------------------------------------
    <br/>
    <pre>
{{ JSON.stringify(upstreamPool, null, 2) }}
</pre>
</div>

<script>
    // https://github.com/moment/moment/issues/463#issuecomment-552498641
    function formatInt(int) {
        if (int < 10) {
            return `0${int}`;
        }
        return `${int}`;
    }

    function formatDuration(time) {
        const seconds = moment.duration(time).seconds();
        const minutes = moment.duration(time).minutes();
        const hours = moment.duration(time).hours();
        if (hours > 0) {
            return `${formatInt(hours)}:${formatInt(minutes)}:${formatInt(seconds)}`;
        }
        if (minutes > 0) {
            return `${formatInt(minutes)}:${formatInt(seconds)}`;
        }
        return `00:${formatInt(seconds)}`;
    }

    function formatNumber2FixedLength(n) {
        return n.toFixed(3);
    }

    function speed2String(s) {
        if (s < 1024) {
            return '' + s + 'Byte/s';
        } else if (s < Math.pow(1024, 2)) {
            return '' + formatNumber2FixedLength(s / Math.pow(1024, 1)) + 'KB/s';
        } else if (s < Math.pow(1024, 3)) {
            return '' + formatNumber2FixedLength(s / Math.pow(1024, 2)) + 'MB/s';
        } else if (s < Math.pow(1024, 4)) {
            return '' + formatNumber2FixedLength(s / Math.pow(1024, 3)) + 'GB/s';
        } else if (s < Math.pow(1024, 5)) {
            return '' + formatNumber2FixedLength(s / Math.pow(1024, 4)) + 'TB/s';
        } else if (s < Math.pow(1024, 6)) {
            return '' + formatNumber2FixedLength(s / Math.pow(1024, 5)) + 'EB/s';
        }
    }

    function dataCount2String(d) {
        if (d < 1024) {
            return '' + d + 'Byte';
        } else if (d < Math.pow(1024, 2)) {
            return '' + formatNumber2FixedLength(d / Math.pow(1024, 1)) + 'KB';
        } else if (d < Math.pow(1024, 3)) {
            return '' + formatNumber2FixedLength(d / Math.pow(1024, 2)) + 'MB';
        } else if (d < Math.pow(1024, 4)) {
            return '' + formatNumber2FixedLength(d / Math.pow(1024, 3)) + 'GB';
        } else if (d < Math.pow(1024, 5)) {
            return '' + formatNumber2FixedLength(d / Math.pow(1024, 4)) + 'TB';
        } else if (d < Math.pow(1024, 6)) {
            return '' + formatNumber2FixedLength(d / Math.pow(1024, 5)) + 'EB';
        }
    }

    function formatSpeedMax(u) {
        if (u.byteInfo === 'true') {
            return '↑' + speed2String(_.parseInt(u.byteUpChangeMax)) + ' ↓' + speed2String(_.parseInt(u.byteDownChangeMax));
        } else {
            return '↑' + speed2String(0) + ' ↓' + speed2String(0);
        }
    }

    function formatSpeed(u) {
        if (u.byteInfo === 'true') {
            return '↑' + speed2String(_.parseInt(u.byteUpChange)) + ' ↓' + speed2String(_.parseInt(u.byteDownChange));
        } else {
            return '↑' + speed2String(0) + ' ↓' + speed2String(0);
        }
    }

    function formatData(u) {
        if (u.byteInfo === 'true') {
            return '↑' + dataCount2String(_.parseInt(u.byteUpLast)) + ' ↓' + dataCount2String(_.parseInt(u.byteDownLast));
        } else {
            return '↑' + dataCount2String(0) + ' ↓' + dataCount2String(0);
        }
    }


    moment.locale('zh-cn');
    var app = new Vue({
        el: '#body',
        data: {
            test: 11244,
            upstreamPool: [],
            //monitorCenter: refMonitorCenter(),
            //formatTime: (m: moment.Moment | undefined) => {
            //  return m ? m.format('ll HH:mm:ss') : 'undefined';
            //},
            rule: "",
            nowTime: "",
            startTime: "",
            runTime: 0,
            runTimeString: "",
            runTimeString2: "",
            listenOn: "",
            haveUsableServer: true,
            UpstreamSelectRuleList: [],
            lastUseUpstreamIndex: 0,
            lastConnectServerIndex: 0,
            lastConnectServer: {},
            //isWork: checkServer,
            //speedArray: speedArray,
            //dataArray: dataArray,
            newRule: "",
            allConnectCount: 0,
            backend: "127.0.0.1:5010",
            totalUp: 0,
            totalDown: 0,
            totalUpSpeed: 0,
            totalDownSpeed: 0,
            totalUpSpeedMax: 0,
            totalDownSpeedMax: 0,
        },
        methods: {
            formatSpeedMax: formatSpeedMax,
            formatSpeed: formatSpeed,
            formatData: formatData,
            speed2String: speed2String,
            dataCount2String: dataCount2String,
            flush: function () {
                fetch('http://' + app.backend + '/', {
                    credentials: 'omit'
                }).then(function (T) {
                    if (T.ok) {
                        return T.json();
                    }
                    return Promise.reject(T);
                }).then(function (T) {
                    console.log(T);
                    if (
                        _.has(T, 'pool') &&
                        _.has(T, 'config') &&
                        _.isObject(T.pool) &&
                        _.isArray(T.pool.upstream) &&
                        _.isObject(T.config)
                    ) {
                        app.lastUseUpstreamIndex = T.pool.getLastUseUpstreamIndex;
                        app.upstreamPool = T.pool.upstream;
                        app.UpstreamSelectRuleList = T.RuleEnumList;
                        app.rule = T.nowRule;
                        app.newRule = T.nowRule;
                        app.nowTime = T.nowTime;
                        app.runTime = T.runTime;
                        app.totalUp = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteUpLast);
                        }, 0);
                        app.totalDown = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteDownLast);
                        }, 0);
                        app.totalUpSpeed = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteUpChange);
                        }, 0);
                        app.totalDownSpeed = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteDownChange);
                        }, 0);
                        app.totalUpSpeedMax = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteUpChangeMax);
                        }, 0);
                        app.totalDownSpeedMax = _.reduce(app.upstreamPool, function (acc, n) {
                            return acc + _.parseInt(n.byteDownChangeMax);
                        }, 0);
                        app.runTimeString = moment.duration(_.parseInt(T.runTime)).humanize();
                        app.runTimeString2 = formatDuration(_.parseInt(T.runTime));
                        app.startTime = T.startTime;
                        app.lastConnectServerIndex = _.parseInt(T.lastConnectServerIndex);
                        app.lastConnectServer = app.upstreamPool.find(function (n) {
                            return _.parseInt(n.index) === app.lastConnectServerIndex;
                        });
                        app.listenOn = ' ' + T.config.listenHost + ' : ' + T.config.listenPort;

                        app.allConnectCount = _.reduce(T.pool.upstream, function (acc, T) {
                            return acc + _.parseInt(T.connectCount);
                        }, 0);
                    }
                }).then(function () {
                    console.log(app);
                }).catch(function (e) {
                    console.error(e);
                });
            },
            sendCommand: function (cmd) {
                fetch('http://' + app.backend + cmd, {
                    credentials: 'omit'
                }).then(function (T) {
                    if (T.ok) {
                        return T;
                    }
                    return Promise.reject(T);
                }).catch(function (e) {
                    console.error(e);
                }).then(function () {
                    app.flush();
                });
            },
        }
    });
    app.flush();
</script>
</body>
</html>
